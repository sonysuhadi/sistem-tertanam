#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>
#include <ESP8266mDNS.h>

const char* ssid = "SSID";
const char* password = "PASSWORD";

ESP8266WebServer server(80);
String webPage = "";

// PIN
int pinA = D0;
int pinB = D1;
int pinC = D2;
int ldrPin = D3;

// FLAG MANUAL
bool forceOn1 = false, forceOff1 = false;
bool forceOn2 = false, forceOff2 = false;
bool forceOn3 = false, forceOff3 = false;

// STATE LDR
bool ldrState = false;

// FUNGSI LED
void hidupR1(){ digitalWrite(pinA, HIGH); }
void hidupR2(){ digitalWrite(pinB, HIGH); }
void hidupR3(){ digitalWrite(pinC, HIGH); }

void matiR1(){ digitalWrite(pinA, LOW); }
void matiR2(){ digitalWrite(pinB, LOW); }
void matiR3(){ digitalWrite(pinC, LOW); }

void setup() {

  // ============================
  // HALAMAN WEB
  // ============================
  webPage  = "<html><head><title>SMART LIGHTING</title>";
  webPage += "<style>body{font-family:Arial;padding:20px;}button{padding:12px 20px;margin:5px;font-size:16px;}</style>";
  webPage += "</head><body>";
  webPage += "<h2>SMART LIGHTING SYSTEM</h2><hr>";

  webPage += "<h3>Ruangan 1</h3>";
  webPage += "<a href='/LEDOn1'><button>ON</button></a>";
  webPage += "<a href='/LEDOff1'><button>OFF</button></a><br><br>";

  webPage += "<h3>Ruangan 2</h3>";
  webPage += "<a href='/LEDOn2'><button>ON</button></a>";
  webPage += "<a href='/LEDOff2'><button>OFF</button></a><br><br>";

  webPage += "<h3>Ruangan 3</h3>";
  webPage += "<a href='/LEDOn3'><button>ON</button></a>";
  webPage += "<a href='/LEDOff3'><button>OFF</button></a><br><br>";

  webPage += "</body></html>";


  // PIN SETUP
  pinMode(pinA, OUTPUT);
  pinMode(pinB, OUTPUT);
  pinMode(pinC, OUTPUT);
  pinMode(ldrPin, INPUT_PULLUP);

  Serial.begin(115200);
  WiFi.begin(ssid, password);

  Serial.print("Menghubungkan ke WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.print("\nIP: ");
  Serial.println(WiFi.localIP());

  // ============================
  // MODE OTOMATIS SAAT STARTUP
  // ============================
  ldrState = digitalRead(ldrPin);

  if (ldrState == HIGH) { 
    // LDR terang
    matiR1(); matiR2(); matiR3();
  } else {  
    // LDR gelap
    hidupR1(); hidupR2(); hidupR3();
  }

  // ============================
  // ROUTING WEB
  // ============================
  server.on("/", []() {
    server.send(200, "text/html", webPage);
  });

  server.on("/LEDOn1", []() {
    forceOn1 = true; forceOff1 = false;
    hidupR1();
    Serial.println("LED 1 ON (Manual)");
    server.send(200, "text/html", webPage);
  });

  server.on("/LEDOn2", []() {
    forceOn2 = true; forceOff2 = false;
    hidupR2();
    Serial.println("LED 2 ON (Manual)");
    server.send(200, "text/html", webPage);
  });

  server.on("/LEDOn3", []() {
    forceOn3 = true; forceOff3 = false;
    hidupR3();
    Serial.println("LED 3 ON (Manual)");
    server.send(200, "text/html", webPage);
  });

  server.on("/LEDOff1", []() {
    forceOff1 = true; forceOn1 = false;
    matiR1();
    Serial.println("LED 1 OFF (Manual)");
    server.send(200, "text/html", webPage);
  });

  server.on("/LEDOff2", []() {
    forceOff2 = true; forceOn2 = false;
    matiR2();
    Serial.println("LED 2 OFF (Manual)");
    server.send(200, "text/html", webPage);
  });

  server.on("/LEDOff3", []() {
    forceOff3 = true; forceOn3 = false;
    matiR3();
    Serial.println("LED 3 OFF (Manual)");
    server.send(200, "text/html", webPage);
  });

  server.begin();
}

void loop() {
  server.handleClient();

  ldrState = digitalRead(ldrPin);

  // ============================
  // MODE OTOMATIS (HANYA JIKA BELUM DI-FORCE)
  // ============================

  if (!forceOn1 && !forceOff1) {
    if (ldrState == LOW) hidupR1();
    else matiR1();
  }

  if (!forceOn2 && !forceOff2) {
    if (ldrState == LOW) hidupR2();
    else matiR2();
  }

  if (!forceOn3 && !forceOff3) {
    if (ldrState == LOW) hidupR3();
    else matiR3();
  }
}
